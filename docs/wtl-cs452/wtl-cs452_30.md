# 第30讲 - 上电

### 公共服务公告

1.  期末考试日期：8月7日上午9点至8月9日上午11点30分

* * *

## 上电

当您打开电源或按下复位按钮时，在看到`RedBoot>`提示之前会发生什么？

+   上电会断言CPU的复位输入

这不是由指令集架构（ISA）确定的。

+   ISA仅保证CPU将（在将来某个时间）将pc设置为0x00000000并开始执行指令。

在此之前发生的事情，以及0x00000000处出现的内容由芯片上CPU周围系统的设计确定。

+   Cirrus提供此功能，而非ARM。

+   Cirrus提供的内容非常通用：在其他SoC上步骤相同，但细节不同。

可能发生两种相当严格的复位。

1.  打开电源

1.  按下复位按钮

    +   上电，但内存刷新持续运行。

（跳转到0x00000000是一种更温和的复位。）

施加SoC的复位输入，会使SoC的复位输出断言。

+   输出复位到处都去，用上电复位重置所有内容。

取消复位输入会启动引导序列，SoC处于复位状态。十个硬件输入确定SoC的引导方式

+   内部/外部

+   预启动源

+   看门狗状态

+   预启动和预预启动的总线宽度

这些输入允许承载SoC的板设计者确定引导状态的足够特性，以便用于许多应用

TS-7200设置为内部预启动，源自32位AHB上的闪存

AHB总线具有所有重要的高速组件

+   内存（程序和图形）

+   以太网控制器

+   USB控制器

+   `0x80090000`处有16K字节的掩模编程ROM

### 初始状态

#### ARM

以下通过系统控制协处理器控制的事物，由CPU架构确定。它们必须独立于Cirrus添加的内容

1.  MMU平坦，但软复位可能不同

1.  缓存禁用

1.  总线时钟慢

1.  禁用中断

1.  小端内存系统

1.  无法访问MMU寄存器

1.  正常异常寄存器

#### Cirrus

以下在EP9302文档中描述的事物是Cirrus添加的硬件属性。它们独立于Technologic在设计TS7200时配置芯片的方式。

1.  DRAM控制器未初始化

1.  闪存控制器未初始化

1.  所有I/O设备处于复位状态。（它们从CPU接收硬件复位输入。）

1.  引导模式下的内存映射

#### Technologic

以下在Technologic文档、手册和电路图中描述的事物是TS7200的属性

1.  引导控制位，设置为正常引导，32位总线宽度，同步引导设备，内部，看门狗定时器禁用。

1.  物理内存映射

    +   0x80000000至0x800fffff，由Cirrus用于芯片上的组件

    +   SDRAM芯片将内存分为4M块。4M块的地址为

        +   `0x00000000`至`0x003fffff`

        +   `0x00400000`至`0x007fffff`

        +   `0x00800000`至`0x00bfffff`

        +   `0x00c00000`至`0x00ffffff`

        +   `0x01000000`至`0x013fffff`

        +   ...

    +   TS7200使用4位芯片选择将内存分成256 M字节块

        +   0x00000000至0x0fffffff（前256M）SDRAM，CS0，32总线周期

        +   0x10000000至0x1fffffff：CS1，8位总线周期

        +   0x20000000至0x2fffffff：CS2，16位总线周期

        +   0x60000000至0x7fffffff：CS6/7，闪存

        +   0x80000000至0x8fffffff：包括I/O寄存器

            +   0x80000000至0x807fffff：AHB映射寄存器，包括

                +   DMA

                +   以太网

                +   USB

                +   内存控制器

                +   预预引导ROM

                +   ICU寄存器

            +   0x80800000至0x8fffffff：I/O寄存器

        SDRAM芯片将内存分成4M块。 4M块的地址为

    +   `0x00000000`至`0x003fffff`

    +   `0x00400000`至`0x007fffff`

    +   `0x00800000`至`0x00bfffff`

    +   `0x00c00000`至`0x00ffffff`

    +   `0x01000000`至`0x013fffff`

    +   ...

1.  在AHB寄存器中有一个16K的ROM块，从`0x80090000`到`0x80093fff`

    +   最初，它被映射到整个内存空间，间隔为16K。

    +   芯片选择，以及寻址发生的方式。

        +   此块的芯片选择为`0x8009[00XXb]XXX`

        +   芯片选择有两部分

            +   I/O芯片选择：`0x8XXXXXXX`

            +   AHB芯片选择：`0xY00XXXXX`

            +   ROM芯片选择：`0xYYY9[00XXb]XXX`

    +   执行的第一条指令是在`0x80090000`找到的

### 预预引导序列

1.  跳转到`0x80090018.`

1.  打开LED

1.  使CPU完全普通。 例如，

    +   没有缓存，物理内存映射，

1.  关闭看门狗定时器

1.  获取引导状态

1.  配置外部时钟（串行引导所需）

1.  获取引导状态配置输入

    +   这些是EP9302上的输入引脚，其状态由TS7200确定。

    +   通过跳线器可由用户控制的一对

    +   它们是EP9302了解外部世界的唯一事物

1.  使用引导状态配置

    +   闪存存储控制器

    +   SDRAM内存控制器

    这些配置具有非常保守的参数

1.  清除引导模式`内存映射'

1.  切换LED

1.  开关

    +   串行引导在UART1上

        1.  输出“>”

        1.  从CRUS或SURC开始读取2048字节到以太网缓冲区

        1.  跳转到以太网缓冲区的起始位置

    +   从SoC外部的ROM引导

        1.  断言ROM芯片选择，寻找CRUS

        1.  当找到时，从ROM读取2048字节到以太网缓冲区

        1.  跳转到以太网缓冲区的起始位置

    +   从闪存引导

        1.  在可能的闪存起始位置寻找CRUS

        1.  找到后跳转到起始位置加`0x4（考虑CRUS）`

        1.  如果找不到

            +   将代码加载到以太网缓冲区

            +   永远闪烁LED

1.  在前两种情况下，2048字节包含内存测试，然后是加载程序。

### 预引导序列

此代码完全了解EP9302，以及TS7200。

1.  在以太网缓冲区中设置堆栈

1.  将CPSR设置为普通状态：无中断，svc模式

1.  从闪存复制260个字的代码到以太网缓冲区

1.  初始化内存控制器以适应其具有的内存

1.  配置GPIO。

1.  关闭看门狗定时器

1.  为监视器设置适当的串行端口

* * *

返回到：

+   [比尔·考恩在s12的CS452讲座笔记](index.html)

+   [比尔·考恩2012年春季的CS452页面](../index.html)

+   [比尔·考恩的CS452页面](../../index.html)

+   [比尔·考恩的教学页面](../../../index.html)

+   [比尔·考恩的个人主页](../../../../index.html)
