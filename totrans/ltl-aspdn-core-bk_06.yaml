- en: Security and identity
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Security and identity
  id: totrans-1
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Security is a major concern of any modern web application or API. It's important
    to keep your user or customer data safe and out of the hands of attackers. This
    encompasses things like
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
- en: Sanitizing data input to prevent SQL injection attacks
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Preventing cross-domain (XSRF) attacks in forms
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Using HTTPS (TLS) so data can't be intercepted as it travels over the Internet
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Giving users a way to securely sign in with a password or social login credentials
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Designing password reset or multi-factor authentication flows with security
    in mind
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'ASP.NET Core can help make all of this easier to implement. The first two (protection
    against SQL injection and cross-domain attacks) are already built-in, and you
    can add a few lines of code to enable HTTPS support. This chapter will mainly
    focus on the **identity** aspects of security: handling user accounts (registration,
    login), authenticating (logging in) your users securely, and making authorization
    decisions once they are authenticated.'
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
- en: Authentication and authorization are distinct ideas that are often confused.
    **Authentication** deals with whether a user is logged in, while **authorization**
    deals with what they are allowed to do *after* they log in. You can think of authentication
    as asking the question, "Do I know who this user is?" While authorization asks,
    "Does this user have permission to do X?"
  id: totrans-9
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: The MVC + Individual Authentication template you used to scaffold the project
    includes a number of classes built on top of ASP.NET Core Identity, an authentication
    and identity system that's part of ASP.NET Core.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
- en: What is ASP.NET Core Identity?
  id: totrans-11
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: ASP.NET Core Identity is the identity system that ships with ASP.NET Core. Like
    everything else in the ASP.NET Core ecosystem, it's a set of NuGet packages that
    can be installed in any project (and are already included if you use the default
    template).
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
- en: ASP.NET Core Identity takes care of storing user accounts, hashing and storing
    passwords, and managing roles for users. It supports email/password login, multi-factor
    authentication, social login with providers like Google and Facebook, as well
    as connecting to other services using protocols like OAuth 2.0 and OpenID Connect.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
- en: The Register and Login views that ship with the MVC + Individual Auth template
    already take advantage of ASP.NET Core Identity, and they already work! Try registering
    for an account and logging in.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
- en: Add Facebook login
  id: totrans-15
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Add Facebook login
  id: totrans-16
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Out of the box, the Individual Auth template includes functionality for registering
    using an email and password. You can extend this by plugging in additional identity
    providers like Google and Facebook.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
- en: 'For any external provider, you typically need to do two things:'
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
- en: Create an app (sometimes called a *client*) on the external provider that represents
    your application
  id: totrans-19
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Copy the ID and secret generated by the provider and put them in your code
  id: totrans-20
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Create an app in Facebook
  id: totrans-21
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: You can create new Facebook apps using the Facebook Developer console at [https://developers.facebook.com/apps](https://developers.facebook.com/apps).
    Click **Add a New App** and follow the instructions to create an app ID.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以使用Facebook开发人员控制台在[https://developers.facebook.com/apps](https://developers.facebook.com/apps)上创建新的Facebook应用程序。单击**添加新应用**，然后按照说明创建应用程序ID。
- en: If you don't have a Facebook account, you can set up Google or Twitter login
    instead. The steps on the provider's site will be different, but the code is almost
    identical.
  id: totrans-23
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: 如果您没有Facebook帐户，可以选择设置Google或Twitter登录。提供商网站上的步骤可能不同，但代码几乎相同。
- en: 'Next, set up Facebook Login and then click Settings on the left side, under
    Facebook Login:'
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，设置Facebook登录，然后在左侧点击设置，在Facebook登录下方：
- en: '![Settings button](facebook-login-settings.png)'
  id: totrans-25
  prefs: []
  type: TYPE_IMG
  zh: '![设置按钮](facebook-login-settings.png)'
- en: 'Add the following URL to the **Valid OAuth redirect URIs** box:'
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 将以下URL添加到**有效的OAuth重定向URI**框中：
- en: '[PRE0]'
  id: totrans-27
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: The port that your application runs on may differ. It's typically port 5000
    if you use `dotnet start`, but if you're on Windows, it could be a random port
    like 54574\. Either way, you can always see the port your application is running
    on in the address bar of your web browser.
  id: totrans-28
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: 您的应用程序运行的端口可能不同。如果使用`dotnet start`，通常是端口5000，但如果您使用Windows，则可能是随机端口，如54574。无论如何，您始终可以在Web浏览器的地址栏中看到应用程序正在运行的端口。
- en: Click **Save Changes** and then head over to the Dashboard page. Here you can
    see the app ID and secret generated by Facebook, which you'll need in a moment
    (keep this tab open).
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 单击**保存更改**，然后转到仪表板页面。在这里，您可以看到Facebook生成的应用ID和密钥，您一会儿会需要这些信息（保持此选项卡打开）。
- en: 'To enable Facebook login in ASP.NET Core Identity, add this code anywhere in
    the `ConfigureServices` method in the `Startup` class:'
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 要在ASP.NET Core Identity中启用Facebook登录，请在`Startup`类的`ConfigureServices`方法中的任何位置添加以下代码：
- en: '[PRE1]'
  id: totrans-31
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: Instead of hardcoding the Facebook app ID and secret in your code, the values
    are pulled from the configuration system. The `appsettings.json` file is normally
    the place to store configuration data for your project. However, since it's checked
    into source control, it's not good for sensitive data like an app secret. (If
    your app secret was pushed to GitHub, for example, anyone could steal it and do
    bad things on your behalf.)
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 不要在代码中硬编码Facebook应用ID和密钥，而是从配置系统中提取这些值。`appsettings.json`文件通常是存储项目配置数据的地方。但是，由于它被检入源代码控制，因此不适合存储敏感数据，如应用程序密钥。（例如，如果您的应用程序密钥被推送到GitHub，任何人都可以窃取它并代表您执行不良操作。）
- en: Store secrets safely with the Secrets Manager
  id: totrans-33
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用Secrets Manager安全存储秘密
- en: 'You can use the Secrets Manager tool for sensitive data like an app secret.
    Run this line in the terminal to make sure it''s installed (make sure you''re
    currently in the project directory):'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以使用Secrets Manager工具处理敏感数据，如应用程序密钥。在终端中运行此行以确保已安装（确保您当前在项目目录中）：
- en: '[PRE2]'
  id: totrans-35
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'Copy the app ID and secret from the Facebook app dashboard and use the `set`
    command to save the values in the Secrets Manager:'
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 从Facebook应用仪表板复制应用ID和密钥，然后使用`set`命令将这些值保存在Secrets Manager中：
- en: '[PRE3]'
  id: totrans-37
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: The values from the Secrets Manager are loaded into the `Configuration` property
    when your application starts up, so they're available to the code in `ConfigureServices`
    you added before.
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: 当您的应用程序启动时，Secrets Manager中的值将加载到`Configuration`属性中，因此它们在您之前添加的`ConfigureServices`中的代码中可用。
- en: 'Run your application and click the Login link in the navbar. You''ll see a
    new button for logging in with Facebook:'
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 运行您的应用程序，然后单击导航栏中的登录链接。您将看到一个新的用于使用Facebook登录的按钮：
- en: '![Facebook login button](facebook-login-button.png)'
  id: totrans-40
  prefs: []
  type: TYPE_IMG
  zh: '![Facebook登录按钮](facebook-login-button.png)'
- en: Try logging in with Facebook. You'll be redirected and prompted to give your
    app permission in Facebook, then redirected back and logged in.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 尝试使用Facebook登录。您将被重定向并提示在Facebook中授予您的应用程序权限，然后重���向回来并登录。
- en: Require authentication
  id: totrans-42
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 要求身份验证
- en: Require authentication
  id: totrans-43
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 要求身份验证
- en: Often you'll want to require the user to log in before they can access certain
    parts of your application. For example, it makes sense to show the home page to
    everyone (whether you're logged in or not), but only show your to-do list after
    you've logged in.
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 通常，您希望要求用户在访问应用程序的某些部分之前先登录。例如，向每个人显示主页是有意义的（无论您是否已登录），但只有在登录后才显示待办事项清单。
- en: 'You can use the `[Authorize]` attribute in ASP.NET Core to require a logged-in
    user for a particular action, or an entire controller. To require authentication
    for all actions of the `TodoController`, add the attribute above the first line
    of the controller:'
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  id: totrans-46
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'Add this `using` statement at the top of the file:'
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  id: totrans-48
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: Try running the application and accessing `/todo` without being logged in. You'll
    be redirected to the login page automatically.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
- en: Despite the name of the attribute, we are really doing an authentication check
    here, not an authorization check. Sorry to be confusing.
  id: totrans-50
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: Using identity in the application
  id: totrans-51
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Using identity in the application
  id: totrans-52
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The to-do list items themselves are still shared between all users, because
    the to-do entities aren't tied to a particular user. Now that the `[Authorize]`
    attribute ensures that you must be logged in to see the to-do view, you can filter
    the database query based on who is logged in.
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
- en: 'First, inject a `UserManager<ApplicationUser>` into the `TodoController`:'
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
- en: '**`Controllers/TodoController.cs`**'
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  id: totrans-56
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'You''ll need to add a new `using` statement at the top:'
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  id: totrans-58
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'The `UserManager` class is part of ASP.NET Core Identity. You can use it to
    look up the current user in the `Index` action:'
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  id: totrans-60
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'The new code at the top of the action method uses the `UserManager` to get
    the current user from the `User` property available in the action:'
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  id: totrans-62
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: If there is a logged-in user, the `User` property contains a lightweight object
    with some (but not all) of the user's information. The `UserManager` uses this
    to look up the full user details in the database via the `GetUserAsync`.
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
- en: 'The value of `currentUser` should never be null, because the `[Authorize]`
    attribute is present on the controller. However, it''s a good idea to do a sanity
    check, just in case. You can use the `Challenge()` method to force the user to
    log in again if their information is missing:'
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  id: totrans-65
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'Since you''re now passing an `ApplicationUser` parameter to `GetIncompleteItemsAsync`,
    you''ll need to update the `ITodoItemService` interface:'
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
- en: '**`Services/ITodoItemService.cs`**'
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  id: totrans-68
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: The next step is to update the database query and show only items owned by the
    current user.
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
- en: Update the database
  id: totrans-70
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'You''ll need to add a new property to the `TodoItem` entity model so each item
    can reference the user that owns it:'
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE12]'
  id: totrans-72
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'Since you updated the entity model used by the database context, you also need
    to migrate the database. Create a new migration using `dotnet ef` in the terminal:'
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE13]'
  id: totrans-74
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: This creates a new migration called `AddItemOwner` which will add a new column
    to the `Items` table, mirroring the change you made to the `TodoItem` entity model.
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
- en: 'Note: You''ll need to manually tweak the migration file if you''re using SQLite
    as your database. See the *Create a migration* section in the *Use a database*
    chapter for more details.'
  id: totrans-76
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: 'Use `dotnet ef` again to apply it to the database:'
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE14]'
  id: totrans-78
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: Update the service class
  id: totrans-79
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'With the database and the database context updated, you can now update the
    `GetIncompleteItemsAsync` method in the `TodoItemService` and add another clause
    to the `Where` statement:'
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
- en: '**`Services/TodoItemService.cs`**'
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE15]'
  id: totrans-82
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: If you run the application and register or log in, you'll see an empty to-do
    list once again. Unfortunately, any items you try to add disappear into the ether,
    because you haven't updated the Add Item operation to save the current user to
    new items.
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
- en: Update the Add Item and Mark Done operations
  id: totrans-84
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: You'll need to use the `UserManager` to get the current user in the `AddItem`
    and `MarkDone` action methods, just like you did in `Index`. The only difference
    is that these methods will return a `401 Unauthorized` response to the frontend
    code, instead of challenging and redirecting the user to the login page.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
- en: 'Here are both updated methods in the `TodoController`:'
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE16]'
  id: totrans-87
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: 'Both service methods must now accept an `ApplicationUser` parameter. Update
    the interface definition in `ITodoItemService`:'
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE17]'
  id: totrans-89
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: And finally, update the service method implementations in the `TodoItemService`.
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
- en: 'For the `AddItemAsync` method, set the `Owner` property when you construct
    a `new TodoItem`:'
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE18]'
  id: totrans-92
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: 'The `Where` clause in the `MarkDoneAsync` method also needs to check for the
    user''s ID, so a rogue user can''t complete someone else''s items by guessing
    their IDs:'
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE19]'
  id: totrans-94
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: All done! Try using the application with two different user accounts. The to-do
    items stay private for each account.
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
- en: Authorization with roles
  id: totrans-96
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Authorization with roles
  id: totrans-97
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Roles are a common approach to handling authorization and permissions in a web
    application. For example, you might have an Administrator role that allows admins
    to see and manage all the users registered for your app, while normal users can
    only see their own information.
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
- en: Add a Manage Users page
  id: totrans-99
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'First, create a new controller:'
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
- en: '**`Controllers/ManageUsersController.cs`**'
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE20]'
  id: totrans-102
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: Setting the `Roles` property on the `[Authorize]` attribute will ensure that
    the user must be logged in **and** assigned the `Administrator` role in order
    to view the page.
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
- en: 'Next, create a view model:'
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
- en: '**`Models/ManageUsersViewModel.cs`**'
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE21]'
  id: totrans-106
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: 'Finally, create a view for the Index action:'
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
- en: '**`Views/ManageUsers/Index.cshtml`**'
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE22]'
  id: totrans-109
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: 'Start up the application and try to access the `/ManageUsers` route while logged
    in as a normal user. You''ll see this access denied page:'
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
- en: '![Access denied error](access-denied.png)'
  id: totrans-111
  prefs: []
  type: TYPE_IMG
- en: That's because users aren't assigned the `Administrator` role automatically.
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
- en: Create a test administrator account
  id: totrans-113
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: For obvious security reasons, there isn't a checkbox on the registration page
    that makes it easy for anyone to create an administrator account. Instead, you
    can write some code in the `Startup` class that will create a test admin account
    the first time the application starts up.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
- en: 'Add this code to the `if (env.IsDevelopment())` branch of the `Configure` method:'
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
- en: '**`Startup.cs`**'
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE23]'
  id: totrans-117
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: 'The `EnsureRolesAsync` and `EnsureTestAdminAsync` methods will need access
    to the `RoleManager` and `UserManager` services. You can inject them into the
    `Configure` method, just like you inject any service into your controllers:'
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE24]'
  id: totrans-119
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: 'Add the two new methods below the `Configure` method. First, the `EnsureRolesAsync`
    method:'
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE25]'
  id: totrans-121
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: 'This method checks to see if an `Administrator` role exists in the database.
    If not, it creates one. Instead of repeatedly typing the string `"Administrator"`,
    create a small class called `Constants` to hold the value:'
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
- en: '**`Constants.cs`**'
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE26]'
  id: totrans-124
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: Feel free to update the `ManageUsersController` you created before to use this
    constant value as well.
  id: totrans-125
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: 'Next, write the `EnsureTestAdminAsync` method:'
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
- en: '**`Startup.cs`**'
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE27]'
  id: totrans-128
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: If there isn't already a user with the username `admin@todo.local` in the database,
    this method will create one and assign a temporary password. After you log in
    for the first time, you should change the account's password to something secure.
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
- en: Because these two methods are asynchronous and return a `Task`, the `Wait` method
    must be used in `Configure` to make sure they finish before `Configure` moves
    on. You'd normally use `await` for this, but for technical reasons you can't use
    `await` in `Configure`. This is a rare exception - you should use `await` everywhere
    else!
  id: totrans-130
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: When you start the application next, the `admin@todo.local` account will be
    created and assigned the `Administrator` role. Try logging in with this account,
    and navigating to `http://localhost:5000/ManageUsers`. You'll see a list of all
    users registered for the application.
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
- en: As an extra challenge, try adding more administration features to this page.
    For example, you could add a button that gives an administrator the ability to
    delete a user account.
  id: totrans-132
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: Check for authorization in a view
  id: totrans-133
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: The `[Authorize]` attribute makes it easy to perform an authorization check
    in a controller or action method, but what if you need to check authorization
    in a view? For example, it would be nice to display a "Manage users" link in the
    navigation bar if the logged-in user is an administrator.
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
- en: 'You can inject the `UserManager` directly into a view to do these types of
    authorization checks. To keep your views clean and organized, create a new partial
    view that will add an item to the navbar in the layout:'
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
- en: '**`Views/Shared/_AdminActionsPartial.cshtml`**'
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE28]'
  id: totrans-137
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: A **partial view** is a small piece of a view that gets embedded into another
    view. It's common to name partial views starting with an `_` underscore, but it's
    not necessary.
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
- en: This partial view first uses the `SignInManager` to quickly determine whether
    the user is logged in. If they aren't, the rest of the view code can be skipped.
    If there *is* a logged-in user, the `UserManager` is used to look up their details
    and perform an authorization check with `IsInRoleAsync`. If all checks succeed,
    a navbar item is rendered.
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
- en: 'To include this partial in the main layout, edit `_Layout.cshtml` and add it
    in the navbar section:'
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
- en: '**`Views/Shared/_Layout.cshtml`**'
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE29]'
  id: totrans-142
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: 'When you log in with an administrator account, you''ll now see a new item on
    the top right:'
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 当您使用管理员帐户登录时，您现在会在右上角看到一个新项目：
- en: '![Manage Users link](manage-users.png)'
  id: totrans-144
  prefs: []
  type: TYPE_IMG
  zh: '![管理用户链接](manage-users.png)'
- en: Wrap up
  id: totrans-145
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 总结
- en: ASP.NET Core Identity is a powerful security and identity system that helps
    you add authentication and authorization checks, and makes it easy to integrate
    with external identity providers. The `dotnet new` templates give you pre-built
    views and controllers that handle common scenarios like login and registration
    so you can get up and running quickly.
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: ASP.NET Core Identity 是一个强大的安全和身份系统，可帮助您添加身份验证和授权检查，并且轻松集成外部身份提供者。`dotnet new`
    模板为您提供了预构建的视图和控制器，处理常见场景，如登录和注册，因此您可以快速启动。
- en: There's much more that ASP.NET Core Identity can do. You can learn more in the
    documentation and examples available at [https://docs.asp.net](https://docs.asp.net).
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: ASP.NET Core Identity 还有更多功能。您可以在[https://docs.asp.net](https://docs.asp.net)上的文档和示例中了解更多。
